<!DOCTYPE html>
<html>
    <head>
        <style>
            * {
                padding: 0;
                margin: 0;
            }
            input {
                height: 20px;
            }
            #select > img {
                width: 9.5vw;
                cursor: pointer;
            }
            #root > img {
                /* width: 33vw; */
                width: 24.5vw;
            }
        </style>
    </head>
    <body>
        page: <input id="page" value="1" type="number"/>
        <button onclick="init()">开始</button>
        <button onclick="init(true)">下一页</button>
        <span id="status"></span>
        <div id="select"></div>
        <div id="root"></div>
        <script>
            const select = document.getElementById('select');
            const root = document.getElementById('root');
            const pageIpt = document.getElementById('page');
            const status = document.getElementById('status');
            const query = new URL(location.href).searchParams;

            opener && opener.focusTab();
            function focusTab() {
                window.focus();
            } 
            function loading(val) {
                const txt = 'loading...';
                if (val === undefined) {
                    return status.innerHTML === txt;
                } else {
                    status.innerHTML = val ? txt : '';
                }
            }
            function init(val) {
                val && (pageIpt.value -= -1);
                const page = pageIpt.value;
                fetch(`/links?page=${page}`).then(res => res.json()).then(res => {
                    select.innerHTML = Object.keys(res).map(i => {
                        return `<img src="${res[i]}" onclick="selectImg('${i}')" oncontextmenu="openPage('${page}','${i}')"/>`
                    }).join('');
                })
            }
            function selectImg(url) {
                if (loading()) {
                    return;
                }
                loading(true);
                fetch(`/link?url=${encodeURIComponent(url)}`).then(res => res.json()).then(res => {
                    root.innerHTML = res.map(i => `<img src="${i}"/>`).join('');
                }).catch(e => alert('error!')).finally(() => loading(false));
            }
            function openPage(page, url) {
                window.open(`${location.origin}${location.pathname}?page=${page}&url=${encodeURIComponent(url)}`, '_blank')
            }

            const pageq = query.get('page');
            pageq && (pageIpt.value = pageq);
            const urlq = query.get('url');
            init();
            urlq && selectImg(urlq);
        </script>
    </body>
</html>